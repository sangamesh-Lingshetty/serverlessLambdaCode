service: devinsights-api

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-south-1
  stage: ${opt:stage, 'dev'}
  memorySize: 1024
  timeout: 120
  
  environment:
    GITHUB_TOKEN: ${.env:GITHUB_TOKEN}
    NODE_ENV: ${opt:stage, 'dev'}
    UPSTASH_REDIS_REST_URL: ${.env:UPSTASH_REDIS_REST_URL}
    UPSTASH_REDIS_REST_TOKEN: ${.env:UPSTASH_REDIS_REST_TOKEN}
    AWS_STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}

    USER_POOL_ID: !Ref CognitoUserPool
    USER_POOL_CLIENT_ID: !Ref CognitoUserPoolClient
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/DevInsights-*"

        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:ListUsers
          Resource:
            - !GetAtt CognitoUserPool.Arn

  # FIXED INDENTATION + AUTHORIZER
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
        - http://localhost:3001
        - https://*
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - OPTIONS
        - DELETE
      allowCredentials: true

    authorizers:
      cognitoAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: !Sub https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
        audience:
          - !Ref CognitoUserPoolClient


functions:
  healthCheck:
    handler: handlers/github.healthCheck
    events:
      - httpApi:
          path: /api/health
          method: get

  signUp:
    handler: handlers/auth.signUp
    events:
      - httpApi:
          path: /auth/signup
          method: post

  login:
    handler: handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: post

  verifyEmail:
    handler: handlers/auth.verifyEmail
    events:
      - httpApi:
          path: /auth/verify
          method: post

  refreshToken:
    handler: handlers/auth.refreshToken
    events:
      - httpApi:
          path: /auth/refresh
          method: post

  getCurrentUser:
    handler: handlers/auth.getCurrentUser
    events:
      - httpApi:
          path: /auth/me
          method: get

  getUserRepos:
    handler: handlers/github.getUserRepositories
    events:
      - httpApi:
          path: /api/github/repos/{username}
          method: get
          authorizer:
            name: cognitoAuthorizer

  getRepoCommits:
    handler: handlers/github.getRepositoriesCommits
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/commits
          method: get
          authorizer:
            name: cognitoAuthorizer

  getRepoPulls:
    handler: handlers/github.getRepositoriesPullRequest
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/pulls
          method: get
          authorizer:
            name: cognitoAuthorizer

  getRepoIssues:
    handler: handlers/github.getRepositoryIssues
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/issues
          method: get
          authorizer:
            name: cognitoAuthorizer

  getDashboard:
    handler: handlers/github.getDashBoardAnalytics
    timeout: 120
    memorySize: 2048
    events:
      - httpApi:
          path: /api/github/analytics/{username}
          method: get
          authorizer:
            name: cognitoAuthorizer

  getCacheStats:
    handler: handlers/github.getCacheStats
    events:
      - httpApi:
          path: /api/cache/stats
          method: get
          authorizer:
            name: cognitoAuthorizer

  clearUserCache:
    handler: handlers/github.clearUserCache
    events:
      - httpApi:
          path: /api/cache/{username}
          method: delete
          authorizer:
            name: cognitoAuthorizer


plugins:
  - serverless-offline
  - serverless-dotenv-plugin


package:
  patterns:
    - 'handlers/**'
    - 'services/**'
    - 'utils/**'
    - 'node_modules/**'
    - 'package.json'
    - '!.git/**'
    - '!.env'
    - '!.env.*'
    - '!README.md'
    - '!.gitignore'
    - '!.serverless/**'
    - '!test/**'
    - '!*.log'


custom:
  serverless-offline:
    httpPort: 3000
    timeout: 120


resources:
  Resources:

    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-user-pool-${self:provider.stage}
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireUppercase: true
            RequireNumbers: true
            RequireSymbols: false
        Schema:
          - Name: email
            AttributeDataType: String
            Required: true
            Mutable: false
          - Name: name
            AttributeDataType: String
            Required: true
            Mutable: true
          - Name: organizationId
            AttributeDataType: String
            Mutable: true
          - Name: role
            AttributeDataType: String
            Mutable: true
        EmailVerificationMessage: 'Welcome to DevInsights! Your verification code is {####}'
        EmailVerificationSubject: 'Verify your DevInsights account'
        AccountRecoverySetting:
          RecoveryMechanisms:
            - Name: verified_email
              Priority: 1
        UserAttributeUpdateSettings:
          AttributesRequireVerificationBeforeUpdate:
            - email

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-client-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool
        AccessTokenValidity: 1
        IdTokenValidity: 1
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH
        GenerateSecret: false
        ReadAttributes:
          - email
          - name
          - custom:organizationId
          - custom:role
        WriteAttributes:
          - email
          - name
          - custom:organizationId
          - custom:role

  Outputs:
    UserPoolId:
      Description: Cognito User Pool ID
      Value: !Ref CognitoUserPool
    
    UserPoolClientId:
      Description: Cognito User Pool Client ID
      Value: !Ref CognitoUserPoolClient        


service: devinsights-api

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-south-1
  stage: ${opt:stage, 'dev'}
  memorySize: 1024
  timeout: 120
  
  environment:
    GITHUB_TOKEN: ${.env:GITHUB_TOKEN}
    NODE_ENV: ${opt:stage, 'dev'}
    UPSTASH_REDIS_REST_URL: ${.env:UPSTASH_REDIS_REST_URL}
    UPSTASH_REDIS_REST_TOKEN: ${.env:UPSTASH_REDIS_REST_TOKEN}
    AWS_STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}
  

  # IAM PERMISSIONS (Lambda can access DynamoDB)
  iam:
    role:
      statements:
        # Allow Lambda to read/write DynamoDB
        - Effect: Allow
          Action:
            - dynamodb:Query        # Search by partition key
            - dynamodb:Scan         # Search entire table
            - dynamodb:GetItem      # Get single item
            - dynamodb:PutItem      # Create/update item
            - dynamodb:UpdateItem   # Update existing item
            - dynamodb:DeleteItem   # Delete item
          Resource:
            # Allow access to our DynamoDB tables
            - "arn:aws:dynamodb:${self:provider.region}:*:table/DevInsights-*"
        
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
        - http://localhost:3001
        - https://*
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - OPTIONS
        - DELETE
      allowCredentials: true

functions:
  healthCheck:
    handler: handlers/github.healthCheck
    events:
      - httpApi:
          path: /api/health
          method: get

  getUserRepos:
    handler: handlers/github.getUserRepositories
    events:
      - httpApi:
          path: /api/github/repos/{username}
          method: get
    
  getRepoCommits:
    handler: handlers/github.getRepositoriesCommits
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/commits
          method: get

  getRepoPulls:
    handler: handlers/github.getRepositoriesPullRequest
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/pulls
          method: get

  getRepoIssues:
    handler: handlers/github.getRepositoryIssues
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/issues
          method: get

  getDashboard:
    handler: handlers/github.getDashBoardAnalytics
    timeout: 120
    memorySize: 2048
    events:
      - httpApi:
          path: /api/github/analytics/{username}
          method: get

  getCacheStats:
    handler: handlers/github.getCacheStats
    events:
      - httpApi:
          path: /api/cache/stats
          method: get

  clearUserCache:
    handler: handlers/github.clearUserCache
    events:
      - httpApi:
          path: /api/cache/{username}
          method: delete
    
plugins:
  - serverless-offline
  - serverless-dotenv-plugin

# ðŸ”¥ CRITICAL: Package configuration (THIS WAS MISSING!)
package:
  patterns:
    # Include everything needed
    - 'handlers/**'
    - 'services/**'
    - 'utils/**'
    - 'node_modules/**'  # ðŸš¨ MUST include node_modules!
    - 'package.json'
    
    # Exclude unnecessary files
    - '!.git/**'
    - '!.env'
    - '!.env.*'
    - '!README.md'
    - '!.gitignore'
    - '!.serverless/**'
    - '!test/**'
    - '!*.log'

custom:
  serverless-offline:
    httpPort: 3000
    timeout: 120


# AWS RESOURCES (This creates DynamoDB table!)

resources:
  Resources:
    AnalyticsCacheTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: DevInsights-AnalyticsCache-${self:provider.stage}

        BillingMode: PAY_PER_REQUEST

        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S

          - AttributeName: cacheKey
            AttributeType: S

        KeySchema:

          - AttributeName: userId
            KeyType: HASH

          - AttributeName: cacheKey
            KeyType: RANGE

        # TTL Configuration (Auto-delete old data)
        TimeToLiveSpecification:

          AttributeName: expiresAt
          Enabled: true


        # Tags for organization
        Tags:
          - Key: Project
            Value: DevInsights
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: ManagedBy
            Value: Serverless
          
  # Output values (useful for debugging)
  Outputs:
    AnalyticsCacheTableName:
      Description: DynamoDB table name for analytics cache
      Value: !Ref AnalyticsCacheTable
      Export:
        Name: ${self:service}-${self:provider.stage}-CacheTableName
    
    AnalyticsCacheTableArn:
      Description: DynamoDB table ARN
      Value: !GetAtt AnalyticsCacheTable.Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-CacheTableArn




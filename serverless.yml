service: devinsights-api

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-south-1
  stage: ${opt:stage, 'dev'}
  memorySize: 1024
  timeout: 120

  environment:
    GITHUB_TOKEN: ${.env:GITHUB_TOKEN}
    NODE_ENV: ${opt:stage, 'dev'}
    UPSTASH_REDIS_REST_URL: ${.env:UPSTASH_REDIS_REST_URL}
    UPSTASH_REDIS_REST_TOKEN: ${.env:UPSTASH_REDIS_REST_TOKEN}
    AWS_STAGE: ${self:provider.stage}

    # Cognito
    USER_POOL_ID: !Ref CognitoUserPool
    USER_POOL_CLIENT_ID: !Ref CognitoUserPoolClient

  iam:
    role:
      statements:
        # ============================================
        # DYNAMODB PERMISSIONS (ORIGINAL)
        # ============================================
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - !GetAtt AnalyticsCacheTable.Arn
            - !Sub "${AnalyticsCacheTable.Arn}/index/*"

        # ============================================
        # DYNAMODB PERMISSIONS (⭐ NEW TABLES)
        # ============================================
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - !GetAtt OrganizationsTable.Arn
            - !Sub "${OrganizationsTable.Arn}/index/*"
            - !GetAtt UsersTable.Arn
            - !Sub "${UsersTable.Arn}/index/*"
            - !GetAtt InvitationsTable.Arn
            - !Sub "${InvitationsTable.Arn}/index/*"

        # ============================================
        # COGNITO PERMISSIONS
        # ============================================
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminRespondToAuthChallenge
            - cognito-idp:AdminConfirmSignUp
            - cognito-idp:ConfirmSignUp
            - cognito-idp:InitiateAuth
            - cognito-idp:ListUsers
          Resource:
            - !GetAtt CognitoUserPool.Arn

  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
        - http://localhost:3001
        - https://*
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true

functions:
  # ============================================
  # AUTH ENDPOINTS (EXISTING)
  # ============================================

  signUp:
    handler: handlers/auth.signUp
    events:
      - httpApi:
          path: /auth/signup
          method: post

  login:
    handler: handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: post

  verifyEmail:
    handler: handlers/auth.verifyEmail
    events:
      - httpApi:
          path: /auth/verify
          method: post

  refreshToken:
    handler: handlers/auth.refreshToken
    events:
      - httpApi:
          path: /auth/refresh
          method: post

  getCurrentUser:
    handler: handlers/auth.getCurrentUser
    events:
      - httpApi:
          path: /auth/me
          method: get

  # ============================================
  # GITHUB ANALYTICS ENDPOINTS (EXISTING)
  # ============================================

  healthCheck:
    handler: handlers/github.healthCheck
    events:
      - httpApi:
          path: /api/health
          method: get

  getUserRepos:
    handler: handlers/github.getUserRepositories
    timeout: 30
    events:
      - httpApi:
          path: /api/github/repos/{username}
          method: get

  getRepoCommits:
    handler: handlers/github.getRepositoriesCommits
    timeout: 30
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/commits
          method: get

  getRepoPulls:
    handler: handlers/github.getRepositoriesPullRequest
    timeout: 30
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/pulls
          method: get

  getRepoIssues:
    handler: handlers/github.getRepositoryIssues
    timeout: 30
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/issues
          method: get

  getDashboard:
    handler: handlers/github.getDashBoardAnalytics
    timeout: 120
    memorySize: 2048
    events:
      - httpApi:
          path: /api/github/analytics/{username}
          method: get

  getCacheStats:
    handler: handlers/github.getCacheStats
    timeout: 10
    events:
      - httpApi:
          path: /api/cache/stats
          method: get

  clearUserCache:
    handler: handlers/github.clearUserCache
    timeout: 10
    events:
      - httpApi:
          path: /api/cache/{username}
          method: delete

  # ============================================
  # TEAM MANAGEMENT ENDPOINTS (⭐ NEW)
  # ============================================

  createInvitation:
    handler: handlers/invitations.createInvitation
    events:
      - httpApi:
          path: /invitations
          method: post

  getInvitations:
    handler: handlers/invitations.getInvitations
    events:
      - httpApi:
          path: /invitations/{organizationId}
          method: get

  acceptInvitation:
    handler: handlers/invitations.acceptInvitation
    events:
      - httpApi:
          path: /invitations/{token}/accept
          method: post

  getTeamMembers:
    handler: handlers/teams.getTeamMembers
    events:
      - httpApi:
          path: /teams/{organizationId}/members
          method: get

  updateMemberRole:
    handler: handlers/teams.updateMemberRole
    events:
      - httpApi:
          path: /teams/{organizationId}/members/{email}/role
          method: put

  removeMember:
    handler: handlers/teams.removeMember
    events:
      - httpApi:
          path: /teams/{organizationId}/members/{email}
          method: delete

   # ⭐ ADD NEW FUNCTIONS HERE:
  analyzeCodeQuality:
    handler: handlers/ai.analyzeCodeQuality
    timeout: 60
    memorySize: 512
    events:
      - httpApi:
          path: /ai/code-quality/{username}
          method: get

  detectBurnoutRisk:
    handler: handlers/ai.detectBurnoutRisk
    timeout: 60
    memorySize: 512
    events:
      - httpApi:
          path: /ai/burnout-risk/{email}
          method: get

  analyzeTeamPerformance:
    handler: handlers/ai.analyzeTeamPerformance
    timeout: 60
    memorySize: 512
    events:
      - httpApi:
          path: /ai/team-performance/{organizationId}
          method: get

  getAiDashboard:
    handler: handlers/ai.getDashboard
    timeout: 60
    memorySize: 512
    events:
      - httpApi:
          path: /ai/dashboard/{organizationId}
          method: get

  generateReport:
    handler: handlers/ai.generateReport
    timeout: 60
    memorySize: 512
    events:
      - httpApi:
          path: /ai/generate-report/{organizationId}
          method: post

plugins:
  - serverless-offline
  - serverless-dotenv-plugin

package:
  patterns:
    - "handlers/**"
    - "services/**"
    - "utils/**"
    - "node_modules/**"
    - "package.json"
    - "!.git/**"
    - "!.env"
    - "!.env.*"
    - "!README.md"
    - "!.gitignore"
    - "!.serverless/**"
    - "!test/**"
    - "*.log"

custom:
  serverless-offline:
    httpPort: 3000
    timeout: 120

resources:
  Resources:
    # ============================================
    # ANALYTICS CACHE TABLE (EXISTING)
    # ============================================
    AnalyticsCacheTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: DevInsights-AnalyticsCache-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: organizationId
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: OrganizationIndex
            KeySchema:
              - AttributeName: organizationId
                KeyType: HASH
              - AttributeName: SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true
        Tags:
          - Key: Project
            Value: DevInsights
          - Key: Environment
            Value: ${self:provider.stage}

    # ============================================
    # ORGANIZATIONS TABLE (⭐ NEW)
    # ============================================
    OrganizationsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: DevInsights-Organizations-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: organizationId
            AttributeType: S
        KeySchema:
          - AttributeName: organizationId
            KeyType: HASH
        Tags:
          - Key: Project
            Value: DevInsights
          - Key: Environment
            Value: ${self:provider.stage}

    # ============================================
    # USERS TABLE (⭐ NEW)
    # ============================================
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: DevInsights-Users-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S
          - AttributeName: organizationId
            AttributeType: S
        KeySchema:
          - AttributeName: email
            KeyType: HASH
          - AttributeName: organizationId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: OrganizationIndex
            KeySchema:
              - AttributeName: organizationId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Project
            Value: DevInsights
          - Key: Environment
            Value: ${self:provider.stage}

    # ============================================
    # INVITATIONS TABLE (⭐ NEW)
    # ============================================
    InvitationsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: DevInsights-Invitations-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: organizationId
            AttributeType: S
          - AttributeName: invitationId
            AttributeType: S
          - AttributeName: token
            AttributeType: S
        KeySchema:
          - AttributeName: organizationId
            KeyType: HASH
          - AttributeName: invitationId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: TokenIndex
            KeySchema:
              - AttributeName: token
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true
        Tags:
          - Key: Project
            Value: DevInsights
          - Key: Environment
            Value: ${self:provider.stage}

    # ============================================
    # COGNITO USER POOL (EXISTING)
    # ============================================
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-users-${self:provider.stage}
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireUppercase: true
            RequireNumbers: true
            RequireSymbols: false
        Schema:
          - Name: email
            AttributeDataType: String
            Required: true
            Mutable: false
          - Name: name
            AttributeDataType: String
            Required: true
            Mutable: true
          - Name: organizationId
            AttributeDataType: String
            Mutable: true
          - Name: role
            AttributeDataType: String
            Mutable: true
        EmailVerificationMessage: "Welcome to DevInsights! Your verification code is {####}"
        EmailVerificationSubject: "Verify your DevInsights account"
        AccountRecoverySetting:
          RecoveryMechanisms:
            - Name: verified_email
              Priority: 1

    # ============================================
    # COGNITO USER POOL CLIENT (EXISTING)
    # ============================================
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-client-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool
        AccessTokenValidity: 24
        IdTokenValidity: 24
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days
        ExplicitAuthFlows:
          - ALLOW_ADMIN_USER_PASSWORD_AUTH
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH
        GenerateSecret: false
        ReadAttributes:
          - email
          - name
          - custom:organizationId
          - custom:role
        WriteAttributes:
          - email
          - name

  Outputs:
    UserPoolId:
      Description: Cognito User Pool ID
      Value: !Ref CognitoUserPool
      Export:
        Name: ${self:service}-UserPoolId-${self:provider.stage}

    UserPoolClientId:
      Description: Cognito User Pool Client ID
      Value: !Ref CognitoUserPoolClient
      Export:
        Name: ${self:service}-ClientId-${self:provider.stage}

    AnalyticsCacheTableName:
      Description: DynamoDB Analytics Cache Table Name
      Value: !Ref AnalyticsCacheTable
      Export:
        Name: ${self:service}-AnalyticsCacheTableName-${self:provider.stage}

    OrganizationsTableName:
      Description: DynamoDB Organizations Table Name
      Value: !Ref OrganizationsTable
      Export:
        Name: ${self:service}-OrganizationsTableName-${self:provider.stage}

    UsersTableName:
      Description: DynamoDB Users Table Name
      Value: !Ref UsersTable
      Export:
        Name: ${self:service}-UsersTableName-${self:provider.stage}

    InvitationsTableName:
      Description: DynamoDB Invitations Table Name
      Value: !Ref InvitationsTable
      Export:
        Name: ${self:service}-InvitationsTableName-${self:provider.stage}

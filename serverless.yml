service: devinsights-api

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-south-1
  stage: ${opt:stage, 'dev'}
  memorySize: 1024
  timeout: 120
  
  environment:
    # ✅ FIXED: Remove the dot before env
    GITHUB_TOKEN: ${.env:GITHUB_TOKEN}
    NODE_ENV: ${opt:stage, 'dev'}
    UPSTASH_REDIS_REST_URL: ${.env:UPSTASH_REDIS_REST_URL}
    UPSTASH_REDIS_REST_TOKEN: ${.env:UPSTASH_REDIS_REST_TOKEN}
    AWS_STAGE: ${self:provider.stage}
    # ✅ FIXED: Changed REGION to AWS_REGION
    REGION: ${self:provider.region}

    # Cognito
    USER_POOL_ID: !Ref CognitoUserPool
    USER_POOL_CLIENT_ID: !Ref CognitoUserPoolClient
  
  iam:
    role:
      statements:
        # DynamoDB Permissions
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - !GetAtt AnalyticsCacheTable.Arn
            - !Sub "${AnalyticsCacheTable.Arn}/index/*"

        # Cognito Permissions
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminRespondToAuthChallenge
            - cognito-idp:AdminConfirmSignUp
            - cognito-idp:ConfirmSignUp
            - cognito-idp:InitiateAuth
            - cognito-idp:ListUsers
          Resource:
            - !GetAtt CognitoUserPool.Arn

  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
        - http://localhost:3001
        - https://*
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true


functions:
  # ============================================
  # AUTH ENDPOINTS
  # ============================================
  
  signUp:
    handler: handlers/auth.signUp
    events:
      - httpApi:
          path: /auth/signup
          method: post

  login:
    handler: handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: post

  verifyEmail:
    handler: handlers/auth.verifyEmail
    events:
      - httpApi:
          path: /auth/verify
          method: post

  refreshToken:
    handler: handlers/auth.refreshToken
    events:
      - httpApi:
          path: /auth/refresh
          method: post

  getCurrentUser:
    handler: handlers/auth.getCurrentUser
    events:
      - httpApi:
          path: /auth/me
          method: get

  # ============================================
  # GITHUB ANALYTICS ENDPOINTS
  # ============================================

  healthCheck:
    handler: handlers/github.healthCheck
    events:
      - httpApi:
          path: /api/health
          method: get

  getUserRepos:
    handler: handlers/github.getUserRepositories
    timeout: 30
    events:
      - httpApi:
          path: /api/github/repos/{username}
          method: get

  getRepoCommits:
    handler: handlers/github.getRepositoriesCommits
    timeout: 30
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/commits
          method: get

  getRepoPulls:
    handler: handlers/github.getRepositoriesPullRequest
    timeout: 30
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/pulls
          method: get

  getRepoIssues:
    handler: handlers/github.getRepositoryIssues
    timeout: 30
    events:
      - httpApi:
          path: /api/github/repos/{owner}/{repo}/issues
          method: get

  getDashboard:
    handler: handlers/github.getDashBoardAnalytics
    timeout: 120
    memorySize: 2048
    events:
      - httpApi:
          path: /api/github/analytics/{username}
          method: get

  getCacheStats:
    handler: handlers/github.getCacheStats
    timeout: 10
    events:
      - httpApi:
          path: /api/cache/stats
          method: get

  clearUserCache:
    handler: handlers/github.clearUserCache
    timeout: 10
    events:
      - httpApi:
          path: /api/cache/{username}
          method: delete


plugins:
  - serverless-offline
  - serverless-dotenv-plugin


package:
  patterns:
    - 'handlers/**'
    - 'services/**'
    - 'utils/**'
    - 'node_modules/**'
    - 'package.json'
    - '!.git/**'
    - '!.env'
    - '!.env.*'
    - '!README.md'
    - '!.gitignore'
    - '!.serverless/**'
    - '!test/**'
    - '!*.log'


custom:
  serverless-offline:
    httpPort: 3000
    timeout: 120


resources:
  Resources:
    # ============================================
    # DYNAMODB TABLE
    # ============================================
    AnalyticsCacheTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: DevInsights-AnalyticsCache-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: organizationId
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: OrganizationIndex
            KeySchema:
              - AttributeName: organizationId
                KeyType: HASH
              - AttributeName: SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true
        Tags:
          - Key: Project
            Value: DevInsights
          - Key: Environment
            Value: ${self:provider.stage}

    # ============================================
    # COGNITO USER POOL
    # ============================================
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-users-${self:provider.stage}
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireUppercase: true
            RequireNumbers: true
            RequireSymbols: false
        Schema:
          - Name: email
            AttributeDataType: String
            Required: true
            Mutable: false
          - Name: name
            AttributeDataType: String
            Required: true
            Mutable: true
          - Name: organizationId
            AttributeDataType: String
            Mutable: true
          - Name: role
            AttributeDataType: String
            Mutable: true
        EmailVerificationMessage: 'Welcome to DevInsights! Your verification code is {####}'
        EmailVerificationSubject: 'Verify your DevInsights account'
        AccountRecoverySetting:
          RecoveryMechanisms:
            - Name: verified_email
              Priority: 1

    # ============================================
    # COGNITO USER POOL CLIENT
    # ============================================
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-client-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool
        AccessTokenValidity: 24
        IdTokenValidity: 24
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days
        ExplicitAuthFlows:
          - ALLOW_ADMIN_USER_PASSWORD_AUTH 
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH
        GenerateSecret: false
        ReadAttributes:
          - email
          - name
          - custom:organizationId
          - custom:role
        WriteAttributes:
          - email
          - name

  Outputs:
    UserPoolId:
      Description: Cognito User Pool ID
      Value: !Ref CognitoUserPool
      Export:
        Name: ${self:service}-UserPoolId-${self:provider.stage}
    
    UserPoolClientId:
      Description: Cognito User Pool Client ID
      Value: !Ref CognitoUserPoolClient
      Export:
        Name: ${self:service}-ClientId-${self:provider.stage}

    AnalyticsCacheTableName:
      Description: DynamoDB Table Name
      Value: !Ref AnalyticsCacheTable
      Export:
        Name: ${self:service}-TableName-${self:provider.stage}